{% extends 'base.html' %} 
{% load static %} 
{% block head %}
<link rel="stylesheet" href="{% static 'css/passwords/password-index.css' %}" />
{% endblock %} 
{% block content %}


<section class = "password-index-body">

<section class="passwords-container">
    <button class = 'open-button'>New Password</button>
  <h1>Login/Password List</h1>
  {% for password in passwords %}
    <div class="card">
        {{password.id}}
    {% comment %} <a href = '{% url 'password-detail' password.id %}'></a> {% endcomment %}
    <a href = '{% url 'password-detail' password.id %}' >{{password.appname}}</a>
    </div>
    
  {% endfor %}

  
</section>

</section>



<section>
  


  

    <dialog class = 'modal' id = 'createmodal'>
        <button class = 'close-create-button'>x</button>
        <form action = '' id="CreateForm" method="post">
            {% csrf_token %}
    
            <label for="appname">Appname:</label>
            <input type="text" id="appname" name="appname">
            <br />
            
            <label for="username">Username:</label>
            <input type="text" id="username" name="username">
            <br />
            
            <label for="password">Password:</label>
            <div class="password-reveal-container">
                <input type="password" id="create-password" name="password">
                <button type="button" id="generate-password" class="generate-btn">Generate Password</button>
                <button type="button" id="toggle-create-password" class="toggle-btn">
                    <img src="{% static 'images/eye-icon.png' %}" alt="Reveal" />
                </button>
                <button type="button" id="copy-create-password" name="cpy-btn">Copy</button>
            </div>
            <br />
            
            <label for="note">Note:</label>
            <textarea id="note" name="note"></textarea>
            <br />
    
            <button type="submit">Submit</button>
        
        </form>
        
    </dialog>      

<dialog class = 'modal' id = 'updatemodal'>
    
    <button class = 'close-update-button'><a href = '/passwords'>x<a/></button>
    <form action = '' id="UpdateForm" method="post" data-id="{{ updateform.instance.id }}">
        {% csrf_token %}
        {% comment %} {{ updateform.as_p }} {% endcomment %}
        <label for="appname">Name:</label>
        <input type="text" id="appname" name="appname" value="{{ updateform.appname.value }}">
        <br />

        <label for="username">Username:</label>
        <input type="text" id="username" name="username" value="{{ updateform.username.value}}">
        <br />

        <label for="password">Password:</label>
        <div class="password-reveal-container">
            <input type="password" id="update-password" name="password" value="{{ updateform.password.value }}">
            <button type="button" id="toggle-update-password" class="toggle-btn">
                <img src="{% static 'images/eye-icon.png' %}" alt="Reveal" />
            </button>
            <button type="button" id="copy-update-password" name="cpy-btn">Copy</button>
        </div>
        <br />

        <label for="note">Notes:</label>
        <textarea name="note" id="note" name="note">{{ updateform.note.value }}</textarea>
        <br />    

        <button type="submit">Save</button>
        <button type="submit" id="delete-button" class="delete-btn">Delete</button>

    
    </form>
    
</dialog>  



<script>
    





    const createModal = document.querySelector('#createmodal');
    
    const openCreateModal = document.querySelector('.open-button');
    
    const closeCreateModal = document.querySelector('.close-create-button');
    
    
    openCreateModal.addEventListener('click', function () {
        createModal.showModal();
    })
    
    closeCreateModal.addEventListener('click', function () {
        createModal.close();
    })


    const updateModal = document.querySelector('#updatemodal');

    const allPasswords = document.querySelectorAll('.card')

    
    {%if password_id%}
    updateModal.showModal()
    {%endif%}



    const closeUpdateModal = document.querySelector('.close-update-button')

    closeUpdateModal.addEventListener('click', function () {
        updateModal.close();
    });

    // Password reveal functionality for update modal
    const updatePasswordInput = document.getElementById('update-password');
    const toggleUpdatePasswordBtn = document.getElementById('toggle-update-password');
    const updateEyeIcon = toggleUpdatePasswordBtn.querySelector('img');

    toggleUpdatePasswordBtn.addEventListener('click', function () {
        if (updatePasswordInput.type === 'password') {
            updatePasswordInput.type = 'text';
            updateEyeIcon.src = "{% static 'images/eye-icon.png' %}";
            updateEyeIcon.alt = "Hide";
        } else {
            updatePasswordInput.type = 'password';
            updateEyeIcon.src = "{% static 'images/eye-icon.png' %}";
            updateEyeIcon.alt = "Reveal";
        }
    });

    // Function to generate a random strong password
    function generateRandomPassword(length) {
        const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+~`|}{[]:;?><,./-=";
        let password = "";
        for (let i = 0; i < length; i++) {
            const randomIndex = Math.floor(Math.random() * charset.length);
            password += charset[randomIndex];
        }
        return password;
    }

    const createPasswordInput = document.getElementById('create-password');
    const toggleCreatePasswordBtn = document.getElementById('toggle-create-password');
    const generatePasswordBtn = document.getElementById('generate-password');
    const createEyeIcon = toggleCreatePasswordBtn.querySelector('img');

    // Toggle password visibility
    toggleCreatePasswordBtn.addEventListener('click', function () {
        if (createPasswordInput.type === 'password') {
            createPasswordInput.type = 'text';
            createEyeIcon.src = "{% static 'images/eye-icon.png' %}";
            createEyeIcon.alt = "Hide";
        } else {
            createPasswordInput.type = 'password';
            createEyeIcon.src = "{% static 'images/eye-icon.png' %}";
            createEyeIcon.alt = "Reveal";
        }
    });

     // Generate and set random password
     generatePasswordBtn.addEventListener('click', function () {
        const randomPassword = generateRandomPassword(12); // You can change the length as desired
        createPasswordInput.value = randomPassword;
});


    // copy-create-password to clipboard
    const copyCreatePasswordBtn = document.getElementById('copy-create-password');

    copyCreatePasswordBtn.addEventListener('click', function() {
        createPasswordInput.select(); // Selects the text inside this input field
        createPasswordInput.setSelectionRange(0, 99999);

        // Copy the text inside the password input field
        navigator.clipboard.writeText(createPasswordInput.value).then(() => {
            alert("Password copied to clipboard!"); // Optional: give feedback to the user
        }).catch(err => {
            console.error("Failed to copy password: ", err);
        });
    });

    // copy-update-password
    const copyUpdatePasswordBtn = document.getElementById("copy-update-password");

    copyUpdatePasswordBtn.addEventListener("click", function() {
        updatePasswordInput.select();
        updatePasswordInput.setSelectionRange(0, 99999);

        navigator.clipboard.writeText(updatePasswordInput.value).then(() => {
            alert("Password copied to clipboard!");
        }).catch(err => {
            console.error("Failed to copy password: ", err)
        });
    });

    // delete-button functionality
    
    document.addEventListener("DOMContentLoaded", function() {
        const deleteButton = document.getElementById("delete-button");
    
        deleteButton.addEventListener("click", function(event) {
            event.preventDefault(); // Prevent default form submission
    
            // Get the password ID from the form's data attribute
            const form = document.getElementById("UpdateForm");
            const passwordId = form.getAttribute("data-id");
    
            console.log(`Attempting to delete password with ID: ${passwordId}`);
    
            if (confirm("Are you sure you want to delete this password?")) {
                fetch(`/passwords/${passwordId}/delete`, {
                    method: "DELETE",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",  // Django's CSRF token for security
                        "Content-Type": "application/json"
                    },
                })
                .then(response => {
                    console.log(`Response status: ${response.status}`);
                    if (response.ok || response.status === 302) {  // Treat 302 as success
                        alert("Password deleted successfully!");
                        location.reload();  // Optionally, refresh the page or update the UI
                    } else {
                        alert("Failed to delete the password.");
                        console.error("Failed response:", response);
                    }
                })
                .catch(err => {
                    console.error("Error:", err);
                });
            }
        });
    });
            
        
</script>
    


{% endblock %} 